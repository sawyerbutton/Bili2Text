#!/usr/bin/env python3
"""
将转录的txt文档转换为结构化的Markdown格式
"""

import os
import re
from pathlib import Path
import json

def clean_and_segment_text(text):
    """清理文本并进行智能分段"""
    # 移除文件头
    lines = text.split('\n')
    if lines[0].startswith('视频:'):
        lines = lines[3:]  # 跳过前三行

    text = '\n'.join(lines)

    # 修正常见的识别错误
    corrections = {
        'Agent的': 'Agent ',
        'Agent ': 'Agent ',
        'MCP的': 'MCP ',
        'RAG的': 'RAG ',
        'A2A的': 'A2A ',
        'Context的': 'Context ',
        '偷懇': 'Token',
        '紋本': '文本',
        '書入': '输入',
        '反回': '返回',
        '榮譽': '容易',
        '電影': '调用',
        '韓數': '函数',
        '狼Cin': 'LangChain',
        'Chaggbt': 'ChatGPT',
        'GEMON': 'Gemini',
        'JAMMDR': 'Gemini',
        'DipSync': 'DeepSeek',
        'Cloud': 'Claude',
        '記憶': '记忆',
        '領域': '领域',
        '問題': '问题',
        '輸入': '输入',
        '輸出': '输出',
        '數據': '数据',
        '設計': '设计',
        '選擇': '选择',
        '壓縮': '压缩',
        '隔離': '隔离',
        '實現': '实现',
        '技術': '技术',
        '處理': '处理',
        '運行': '运行',
        '執行': '执行',
        '創建': '创建',
        '開始': '开始',
        '結束': '结束',
        '時間': '时间',
        '內容': '内容',
        '信息': '信息',
        '數量': '数量',
        '屬性': '属性',
        '類型': '类型',
        '參數': '参数',
        '請求': '请求',
        '結果': '结果',
        '狀態': '状态',
        '功能': '功能',
        '系統': '系统',
        '工具': '工具',
        '服務': '服务',
        '網絡': '网络',
        '連接': '连接',
        '協議': '协议',
        '規範': '规范',
        '標準': '标准',
        '應用': '应用',
        '開發': '开发',
        '測試': '测试',
        '環境': '环境',
        '配置': '配置',
        '管理': '管理',
        '優化': '优化',
        '分析': '分析',
        '處理': '处理',
        '轉換': '转换',
        '存儲': '存储',
        '讀取': '读取',
        '寫入': '写入',
        '刪除': '删除',
        '更新': '更新',
        '查詢': '查询',
        '搜索': '搜索',
        '過濾': '过滤',
        '排序': '排序',
        '計算': '计算',
        '統計': '统计',
        '顯示': '显示',
        '隱藏': '隐藏',
        '確認': '确认',
        '取消': '取消',
        '提交': '提交',
        '保存': '保存',
        '載入': '载入',
        '匯出': '导出',
        '匯入': '导入',
        '備份': '备份',
        '恢復': '恢复',
        '監控': '监控',
        '報告': '报告',
        '通知': '通知',
        '警告': '警告',
        '錯誤': '错误',
        '成功': '成功',
        '失敗': '失败',
        '進度': '进度',
        '完成': '完成',
        '等待': '等待',
        '準備': '准备',
        '開啟': '开启',
        '關閉': '关闭',
        '啟動': '启动',
        '停止': '停止',
        '暫停': '暂停',
        '繼續': '继续',
        '重試': '重试',
        '回滾': '回滚',
        '升級': '升级',
        '降級': '降级',
        '擴展': '扩展',
        '收縮': '收缩',
        '增加': '增加',
        '減少': '减少',
        '調整': '调整',
        '修改': '修改',
        '設定': '设定',
        '變更': '变更',
        '確定': '确定',
        '驗證': '验证',
        '授權': '授权',
        '認證': '认证',
        '加密': '加密',
        '解密': '解密',
        '簽名': '签名',
        '驗簽': '验签',
        '傳輸': '传输',
        '接收': '接收',
        '發送': '发送',
        '廣播': '广播',
        '訂閱': '订阅',
        '發布': '发布',
        '同步': '同步',
        '異步': '异步',
        '並行': '并行',
        '串行': '串行',
        '鎖定': '锁定',
        '解鎖': '解锁',
        '阻塞': '阻塞',
        '非阻塞': '非阻塞',
        '觸發': '触发',
        '回調': '回调',
        '事件': '事件',
        '監聽': '监听',
        '響應': '响应',
        '處理器': '处理器',
        '中間件': '中间件',
        '插件': '插件',
        '模塊': '模块',
        '組件': '组件',
        '服務器': '服务器',
        '客戶端': '客户端',
        '數據庫': '数据库',
        '緩存': '缓存',
        '隊列': '队列',
        '消息': '消息',
        '通道': '通道',
        '會話': '会话',
        '連結': '链接',
        '節點': '节点',
        '集群': '集群',
        '負載': '负载',
        '均衡': '均衡',
        '容錯': '容错',
        '備援': '备援',
        '災備': '灾备',
        '遷移': '迁移',
        '複製': '复制',
        '備份': '备份',
        '快照': '快照',
        '鏡像': '镜像',
        '克隆': '克隆',
        '分支': '分支',
        '合併': '合并',
        '衝突': '冲突',
        '解決': '解决',
        '提交': '提交',
        '推送': '推送',
        '拉取': '拉取',
        '同步': '同步',
        '標籤': '标签',
        '版本': '版本',
        '發佈': '发布',
        '部署': '部署',
        '構建': '构建',
        '編譯': '编译',
        '打包': '打包',
        '測試': '测试',
        '調試': '调试',
        '優化': '优化',
        '性能': '性能',
        '監控': '监控',
        '日誌': '日志',
        '追蹤': '追踪',
        '分析': '分析',
        '報表': '报表',
        '儀表板': '仪表板',
        '視覺化': '可视化',
        '圖表': '图表',
        '統計': '统计',
        '數據': '数据',
        '指標': '指标',
        '閾值': '阈值',
        '告警': '告警',
        '通知': '通知',
        '郵件': '邮件',
        '短信': '短信',
        '推送': '推送',
        '訂閱': '订阅',
        '取消訂閱': '取消订阅',
        '用戶': '用户',
        '權限': '权限',
        '角色': '角色',
        '群組': '群组',
        '組織': '组织',
        '團隊': '团队',
        '專案': '项目',
        '任務': '任务',
        '工單': '工单',
        '需求': '需求',
        '缺陷': '缺陷',
        '改進': '改进',
        '優化': '优化',
        '重構': '重构',
        '遷移': '迁移',
        '升級': '升级',
        '維護': '维护',
        '支援': '支持',
        '服務': '服务',
        '協助': '协助',
        '幫助': '帮助',
        '文檔': '文档',
        '手冊': '手册',
        '指南': '指南',
        '教程': '教程',
        '範例': '示例',
        '模板': '模板',
        '框架': '框架',
        '庫': '库',
        '套件': '套件',
        '依賴': '依赖',
        '相依性': '依赖性',
        '相容性': '兼容性',
        '版本': '版本',
        '更新': '更新',
        '修補': '修补',
        '補丁': '补丁',
        '熱修復': '热修复',
        '回滾': '回滚',
        '還原': '还原',
        '復原': '复原',
        '撤銷': '撤销',
        '重做': '重做',
        '歷史': '历史',
        '記錄': '记录',
        '追蹤': '追踪',
        '審計': '审计',
        '合規': '合规',
        '安全': '安全',
        '漏洞': '漏洞',
        '威脅': '威胁',
        '風險': '风险',
        '評估': '评估',
        '緩解': '缓解',
        '修復': '修复',
        '防護': '防护',
        '檢測': '检测',
        '掃描': '扫描',
        '監測': '监测',
        '預警': '预警',
        '應急': '应急',
        '恢復': '恢复',
        '備援': '备援',
        '切換': '切换',
        '容災': '容灾',
        '高可用': '高可用',
        '負載均衡': '负载均衡',
        '自動擴展': '自动扩展',
        '彈性伸縮': '弹性伸缩',
        '資源': '资源',
        '配額': '配额',
        '限制': '限制',
        '約束': '约束',
        '規則': '规则',
        '策略': '策略',
        '演算法': '算法',
        '邏輯': '逻辑',
        '流程': '流程',
        '步驟': '步骤',
        '階段': '阶段',
        '狀態': '状态',
        '轉換': '转换',
        '觸發': '触发',
        '條件': '条件',
        '判斷': '判断',
        '決策': '决策',
        '選擇': '选择',
        '路由': '路由',
        '分發': '分发',
        '調度': '调度',
        '排程': '排程',
        '優先級': '优先级',
        '權重': '权重',
        '平衡': '平衡',
        '優化': '优化',
        '調優': '调优',
        '效能': '性能',
        '吞吐': '吞吐',
        '延遲': '延迟',
        '響應': '响应',
        '並發': '并发',
        '同時': '同时',
        '順序': '顺序',
        '有序': '有序',
        '無序': '无序',
        '同步': '同步',
        '異步': '异步',
        '阻塞': '阻塞',
        '非阻塞': '非阻塞',
        '超時': '超时',
        '重試': '重试',
        '回退': '回退',
        '降級': '降级',
        '熔斷': '熔断',
        '限流': '限流',
        '排隊': '排队',
        '緩衝': '缓冲',
        '批次': '批次',
        '批量': '批量',
        '單一': '单一',
        '多重': '多重',
        '複雜': '复杂',
        '簡單': '简单',
        '基礎': '基础',
        '進階': '进阶',
        '高級': '高级',
        '專業': '专业',
        '標準': '标准',
        '自訂': '自定',
        '客製': '定制',
        '通用': '通用',
        '特定': '特定',
        '專用': '专用',
        '共用': '共用',
        '私有': '私有',
        '公開': '公开',
        '內部': '内部',
        '外部': '外部',
        '本地': '本地',
        '遠端': '远程',
        '雲端': '云端',
        '邊緣': '边缘',
        '中心': '中心',
        '分散': '分散',
        '集中': '集中',
        '聚合': '聚合',
        '分離': '分离',
        '整合': '整合',
        '融合': '融合',
        '統一': '统一',
        '標準化': '标准化',
        '規範化': '规范化',
        '自動化': '自动化',
        '智能化': '智能化',
        '可視化': '可视化',
        '數字化': '数字化',
        '虛擬化': '虚拟化',
        '容器化': '容器化',
        '微服務': '微服务',
        '無伺服器': '无服务器',
        '事件驅動': '事件驱动',
        '訊息驅動': '消息驱动',
        '數據驅動': '数据驱动',
        '模型驅動': '模型驱动',
        '領域驅動': '领域驱动',
        '測試驅動': '测试驱动',
        '行為驅動': '行为驱动',
        '敏捷': '敏捷',
        '瀑布': '瀑布',
        '迭代': '迭代',
        '增量': '增量',
        '持續': '持续',
        '整合': '集成',
        '交付': '交付',
        '部署': '部署',
        '發佈': '发布',
        '回饋': '反馈',
        '改善': '改善',
        '學習': '学习',
        '成長': '成长',
        '進步': '进步',
        '突破': '突破',
        '創新': '创新',
        '變革': '变革',
        '轉型': '转型',
        '演進': '演进',
        '革命': '革命',
        '顛覆': '颠覆',
        '重塑': '重塑',
        '再造': '再造',
        '優勢': '优势',
        '劣勢': '劣势',
        '機會': '机会',
        '威脅': '威胁',
        '挑戰': '挑战',
        '困難': '困难',
        '障礙': '障碍',
        '瓶頸': '瓶颈',
        '限制': '限制',
        '約束': '约束',
        '依賴': '依赖',
        '耦合': '耦合',
        '解耦': '解耦',
        '內聚': '内聚',
        '封裝': '封装',
        '抽象': '抽象',
        '繼承': '继承',
        '多態': '多态',
        '接口': '接口',
        '實現': '实现',
        '擴展': '扩展',
        '組合': '组合',
        '聚合': '聚合',
        '關聯': '关联',
        '依賴': '依赖',
        '泛化': '泛化',
        '實現': '实现',
        '包含': '包含',
        '使用': '使用',
        '創建': '创建',
        '銷毀': '销毁',
        '初始化': '初始化',
        '清理': '清理',
        '啟動': '启动',
        '關閉': '关闭',
        '暫停': '暂停',
        '恢復': '恢复',
        '執行': '执行',
        '調用': '调用',
        '返回': '返回',
        '異常': '异常',
        '錯誤': '错误',
        '警告': '警告',
        '信息': '信息',
        '調試': '调试',
        '跟蹤': '跟踪',
        '日誌': '日志',
        '監控': '监控',
        '告警': '告警',
        '通知': '通知',
        '報告': '报告',
        '分析': '分析',
        '統計': '统计',
        '計算': '计算',
        '處理': '处理',
        '轉換': '转换',
        '格式化': '格式化',
        '解析': '解析',
        '編碼': '编码',
        '解碼': '解码',
        '加密': '加密',
        '解密': '解密',
        '壓縮': '压缩',
        '解壓': '解压',
        '打包': '打包',
        '解包': '解包',
        '序列化': '序列化',
        '反序列化': '反序列化',
        '持久化': '持久化',
        '緩存': '缓存',
        '存儲': '存储',
        '檢索': '检索',
        '查詢': '查询',
        '更新': '更新',
        '刪除': '删除',
        '插入': '插入',
        '修改': '修改',
        '替換': '替换',
        '合併': '合并',
        '分割': '分割',
        '截取': '截取',
        '拼接': '拼接',
        '連接': '连接',
        '斷開': '断开',
        '綁定': '绑定',
        '解綁': '解绑',
        '映射': '映射',
        '轉換': '转换',
        '過濾': '过滤',
        '排序': '排序',
        '分組': '分组',
        '聚合': '聚合',
        '統計': '统计',
        '計算': '计算',
        '比較': '比较',
        '匹配': '匹配',
        '查找': '查找',
        '替換': '替换',
        '驗證': '验证',
        '校驗': '校验',
        '檢查': '检查',
        '測試': '测试',
        '評估': '评估',
        '判斷': '判断',
        '決定': '决定',
        '選擇': '选择',
        '執行': '执行',
        '實施': '实施',
        '應用': '应用',
        '使用': '使用',
        '配置': '配置',
        '設置': '设置',
        '調整': '调整',
        '優化': '优化',
        '改進': '改进',
        '增強': '增强',
        '擴展': '扩展',
        '升級': '升级',
        '更新': '更新',
        '維護': '维护',
        '修復': '修复',
        '修正': '修正',
        '糾正': '纠正',
        '調試': '调试',
        '除錯': '除错',
        '診斷': '诊断',
        '分析': '分析',
        '評估': '评估',
        '監測': '监测',
        '追蹤': '追踪',
        '記錄': '记录',
        '報告': '报告',
        '通知': '通知',
        '警示': '警示',
        '提醒': '提醒',
        '確認': '确认',
        '批准': '批准',
        '拒絕': '拒绝',
        '取消': '取消',
        '中止': '中止',
        '終止': '终止',
        '完成': '完成',
        '成功': '成功',
        '失敗': '失败',
        '重試': '重试',
        '回滾': '回滚',
        '恢復': '恢复',
        '備份': '备份',
        '還原': '还原',
        '同步': '同步',
        '複製': '复制',
        '遷移': '迁移',
        '導出': '导出',
        '導入': '导入',
        '上傳': '上传',
        '下載': '下载',
        '發送': '发送',
        '接收': '接收',
        '傳輸': '传输',
        '通信': '通信',
        '交互': '交互',
        '協作': '协作',
        '共享': '共享',
        '分享': '分享',
        '發布': '发布',
        '訂閱': '订阅',
        '推送': '推送',
        '拉取': '拉取',
        '同步': '同步',
        '更新': '更新',
        '刷新': '刷新',
        '重載': '重载',
        '重啟': '重启',
        '重置': '重置',
        '清除': '清除',
        '清理': '清理',
        '釋放': '释放',
        '回收': '回收',
        '銷毀': '销毁',
        '創建': '创建',
        '生成': '生成',
        '產生': '产生',
        '建立': '建立',
        '構建': '构建',
        '編譯': '编译',
        '鏈接': '链接',
        '打包': '打包',
        '部署': '部署',
        '安裝': '安装',
        '卸載': '卸载',
        '啟用': '启用',
        '禁用': '禁用',
        '激活': '激活',
        '停用': '停用',
        '註冊': '注册',
        '註銷': '注销',
        '登入': '登录',
        '登出': '登出',
        '認證': '认证',
        '授權': '授权',
        '鑒權': '鉴权',
        '審核': '审核',
        '批准': '批准',
        '駁回': '驳回',
        '撤銷': '撤销',
        '廢棄': '废弃',
        '歸檔': '归档',
        '存檔': '存档',
        '備份': '备份',
        '快照': '快照',
        '鏡像': '镜像',
        '複本': '副本',
        '主從': '主从',
        '主備': '主备',
        '雙活': '双活',
        '多活': '多活',
        '容災': '容灾',
        '備援': '备援',
        '切換': '切换',
        '故障轉移': '故障转移',
        '負載均衡': '负载均衡',
        '流量分配': '流量分配',
        '路由策略': '路由策略',
        '服務發現': '服务发现',
        '健康檢查': '健康检查',
        '心跳檢測': '心跳检测',
        '狀態監控': '状态监控',
        '性能監控': '性能监控',
        '日誌收集': '日志收集',
        '鏈路追蹤': '链路追踪',
        '調用鏈': '调用链',
        '依賴關係': '依赖关系',
        '拓撲圖': '拓扑图',
        '架構圖': '架构图',
        '流程圖': '流程图',
        '時序圖': '时序图',
        '類圖': '类图',
        '組件圖': '组件图',
        '部署圖': '部署图',
        '用例圖': '用例图',
        '活動圖': '活动图',
        '狀態圖': '状态图',
        '協作圖': '协作图',
        '包圖': '包图',
        '對象圖': '对象图',
        '複合結構圖': '复合结构图',
        '輪廓圖': '轮廓图',
        '交互概覽圖': '交互概览图',
        '時間圖': '时间图'
    }

    for old, new in corrections.items():
        text = text.replace(old, new)

    # 添加标点符号的空格（用于更好的分段）
    text = re.sub(r'([。！？])', r'\1 ', text)

    # 分段
    sentences = re.split(r'[。！？]\s*', text)

    # 合并短句
    paragraphs = []
    current = []
    for sent in sentences:
        if sent.strip():
            current.append(sent.strip())
            # 每3-5句或超过200字符成段
            if len(current) >= 3 or sum(len(s) for s in current) > 200:
                paragraphs.append('。'.join(current) + '。')
                current = []

    if current:
        paragraphs.append('。'.join(current) + '。')

    return paragraphs

def detect_sections(paragraphs):
    """检测文档的主要章节"""
    sections = []
    current_section = None
    current_content = []

    keywords = {
        '介绍': ['首先', '什么是', '定义', '概念', '简单来说'],
        '背景': ['背景', '原因', '为什么', '问题是'],
        '原理': ['原理', '工作机制', '如何工作', '实现方式'],
        '实现': ['实现', '代码', '步骤', '方法', '技术'],
        '例子': ['例如', '比如', '举例', '案例', '场景'],
        '总结': ['总结', '总的来说', '最后', '今天的'],
        '推荐': ['建议', '推荐', '参考', '文章'],
    }

    for para in paragraphs:
        section_found = False
        for section_name, section_keywords in keywords.items():
            if any(kw in para for kw in section_keywords):
                if current_section:
                    sections.append((current_section, current_content))
                current_section = section_name
                current_content = [para]
                section_found = True
                break

        if not section_found and current_section:
            current_content.append(para)
        elif not section_found:
            if not current_section:
                current_section = '引言'
            current_content.append(para)

    if current_section:
        sections.append((current_section, current_content))

    return sections

def convert_to_markdown(input_file, output_file):
    """将单个txt文件转换为markdown"""
    with open(input_file, 'r', encoding='utf-8') as f:
        text = f.read()

    # 获取视频标题
    lines = text.split('\n')
    title = lines[0].replace('视频: ', '').replace('.mp4', '') if lines[0].startswith('视频:') else Path(input_file).stem

    # 清理和分段
    paragraphs = clean_and_segment_text(text)

    # 检测章节
    sections = detect_sections(paragraphs)

    # 构建Markdown
    md_content = f"# {title}\n\n"

    for section_name, section_content in sections:
        if section_name != '引言':
            md_content += f"## {section_name}\n\n"

        for para in section_content:
            md_content += f"{para}\n\n"

    # 保存文件
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(md_content)

    print(f"✅ 转换完成: {output_file}")

def main():
    input_dir = Path("storage/results/mark_transcripts")
    output_dir = Path("storage/results/mark_transcripts/markdown")
    output_dir.mkdir(exist_ok=True)

    txt_files = list(input_dir.glob("*.txt"))
    print(f"📚 找到 {len(txt_files)} 个txt文件待转换")

    for txt_file in txt_files:
        output_file = output_dir / f"{txt_file.stem}.md"
        try:
            convert_to_markdown(txt_file, output_file)
        except Exception as e:
            print(f"❌ 转换失败 {txt_file}: {e}")

if __name__ == "__main__":
    main()